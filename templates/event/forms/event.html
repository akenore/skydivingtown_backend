{% extends "public/secure/components/base.html" %}
{% load static i18n %}
{% block title %}
    {% if object %}
        {% translate "Update event" %}
    {% else %}
        {% translate "Add event" %}
    {% endif %}
{% endblock title %}
{% block head %}
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
{% endblock head %}
{% block nav %}
    {% include "public/secure/components/header.html" %}
{% endblock nav %}
{% block aside %}
    {% include "public/secure/components/sidebar.html" %}
{% endblock aside %}
{% block body %}
    <div class="md:p-4 sm:ml-64">
        <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10 dark:text-gray-300">
            <div class="shadow-md sm:rounded-lg p-8">
                <form method="post" id="event-form">
                    {% csrf_token %}
                    {% for field in form %}
                        <div class="mb-4">
                            <label for="{{ field.id_for_label }}"
                                   class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                {{ field.label }}
                            </label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="text-red-500">
                                    {% for error in field.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div class="w-full px-2 bg-amber-300 dark:bg-amber-900 mb-2 rounded-t-lg">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white py-1">{% translate "Event Dates" %}</h3>
                    </div>
                    <div id="event-dates">
                        {{ eventdate_formset.management_form }}
                        {% for event_date_form in eventdate_formset %}
                            <div class="event-date-form mb-4 p-4 border border-gray-300 rounded-lg">
                                {% for hidden in event_date_form.hidden_fields %}{{ hidden }}{% endfor %}
                                <div class="grid sm:grid-cols-1 md:grid-cols-2 gap-4">
                                    {% for field in event_date_form.visible_fields %}
                                        {% if field.name != 'DELETE' %}
                                            <div class="mb-2">
                                                <label for="{{ field.id_for_label }}"
                                                       class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                                    {{ field.label }}
                                                </label>
                                                {{ field }}
                                                {% if field.errors %}
                                                    <div class="text-red-500">
                                                        {% for error in field.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% if event_date_form.instance.pk %}
                                    <div class="flex justify-end mb-2">
                                        <label class="inline-flex items-center">
                                            {{ event_date_form.DELETE }}
                                            <span class="ml-2 text-red-600">{% translate "Delete this date" %}</span>
                                        </label>
                                    </div>
                                {% endif %}
                                <div class="mt-4 border-t pt-4">
                                    <h4 class="text-md font-medium mb-2">{% translate "Event Times" %}</h4>
                                    <div class="event-times" id="event-times-{{ forloop.counter0 }}">
                                        {{ event_date_form.eventtime_formset.management_form }}
                                        {% for time_form in event_date_form.eventtime_formset %}
                                            <div class="event-time-form mb-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                                                {% for hidden in time_form.hidden_fields %}{{ hidden }}{% endfor %}
                                                <div class="grid sm:grid-cols-1 md:grid-cols-2 gap-4">
                                                    {% for field in time_form.visible_fields %}
                                                        {% if field.name != 'DELETE' %}
                                                            <div class="mb-2">
                                                                <label for="{{ field.id_for_label }}"
                                                                       class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                                                    {{ field.label }}
                                                                </label>
                                                                {{ field }}
                                                                {% if field.errors %}
                                                                    <div class="text-red-500">
                                                                        {% for error in field.errors %}<strong>{{ error|escape }}</strong>{% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% if time_form.instance.pk %}
                                                    <div class="flex justify-end">
                                                        <label class="inline-flex items-center">
                                                            {{ time_form.DELETE }}
                                                            <span class="ml-2 text-red-600">{% translate "Delete this time" %}</span>
                                                        </label>
                                                    </div>
                                                {% else %}
                                                    <div class="flex justify-end">
                                                        <button type="button" class="text-red-600 hover:text-red-800 remove-time">{% translate "Remove" %}</button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button"
                                            class="mt-2 px-3 py-2 text-xs font-medium text-center text-white bg-green-700 rounded-lg hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800"
                                            hx-get="{% url 'add_event_time_form' %}"
                                            hx-target="#event-times-{{ forloop.counter0 }}"
                                            hx-swap="beforeend"
                                            hx-vals='{"date_index": "{{ forloop.counter0 }}"}'>
                                        {% translate "Add event time" %}
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button"
                            id="add-event-date"
                            class="px-3 py-2 text-xs font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 mb-6"
                            hx-get="{% url 'add_event_date_form' %}"
                            hx-target="#event-dates"
                            hx-swap="beforeend"
                            hx-vals='{"index": "{{ eventdate_formset.total_form_count }}"}'>
                        {% translate "Add event date" %}
                    </button>
                    <div class="flex justify-center pt-8">
                        <button class="w-2/4 text-white bg-gradient-to-br from-purple-600 to-blue-500 hover:bg-gradient-to-bl focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2"
                                type="submit">
                            {% if object %}
                                {% translate "Update" %}
                            {% else %}
                                {% translate "Add" %}
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock body %}
{% block scripts %}
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
        
        // Handle removing event time forms that don't have a DELETE checkbox
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-time')) {
                const timeForm = e.target.closest('.event-time-form');
                if (timeForm) {
                    timeForm.remove();
                    updateFormsetCount();
                }
            }
        });
        
        // Update management form counts after adding/removing forms
        function updateFormsetCount() {
            // Update event dates count
            const dateFormset = document.querySelector('#event-dates');
            const dateTotalForms = dateFormset.querySelector('[name="eventdate_set-TOTAL_FORMS"]');
            const dateForms = dateFormset.querySelectorAll('.event-date-form');
            dateTotalForms.value = dateForms.length;
            
            // Update event times count for each date
            dateForms.forEach((dateForm, dateIndex) => {
                const timeFormset = document.querySelector(`#event-times-${dateIndex}`);
                if (timeFormset) {
                    const timeTotalForms = timeFormset.querySelector(`[name="time_${dateIndex}-TOTAL_FORMS"]`);
                    const timeForms = timeFormset.querySelectorAll('.event-time-form');
                    if (timeTotalForms) {
                        timeTotalForms.value = timeForms.length;
                    }
                }
            });
        }
        
        // After HTMX adds a new form
        document.body.addEventListener('htmx:afterSwap', function(event) {
            updateFormsetCount();
        });
    </script>
{% endblock scripts %}
